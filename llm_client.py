# llm_client.py
import os
import json
from openai import OpenAI
# 0) ตั้งค่า Client Typhoon
client = OpenAI(
    api_key=os.environ.get("TYPHOON_API_KEY"),
    base_url="https://api.opentyphoon.ai/v1"
)


# ------------------------------------
# 1) SYSTEM PROMPT
# ------------------------------------
SYSTEM_PROMPT = """
คุณคือผู้ช่วยวิเคราะห์การเงินส่วนบุคคลสำหรับผู้ใช้ชาวไทย ทำหน้าที่สรุปผลจากตัวเลขที่ได้รับเท่านั้น ไม่ต้องคำนวณเองเพิ่ม และต้องแปลงผลลัพธ์ให้ตรงกับช่องบน Dashboard ดังนี้:

1) "left_panel" = สรุปจุดอ่อนหลักเรื่องค่าใช้จ่าย
   - ใช้เปอร์เซ็นต์เทียบเกณฑ์ เช่น “อยู่ที่ X% เกินเกณฑ์ 50%” ปัดเลขทศนิยมด้วย
   - ระบุหมวด culprit พร้อมยอดของหมวดนั้น เช่น “ค่าที่อยู่อาศัยใช้ 7,000 บาท”
   - บอกว่ามันเป็นหมวดที่มากที่สุด
   - หลีกเลี่ยงการพูดตัวเลขใหญ่หลายค่าในประโยคเดียว
   - ห้ามใช้ภาษาที่ทำให้เข้าใจผิดว่ายอด culprit คือจำนวนที่ “เพิ่มขึ้น”
   - ถ้าไม่มีหมวดไหนเกินเกณฑ์ ให้ชมสั้น ๆ เช่น “ไม่มีค่าใช้จ่ายส่วนไหนเกินเกณฑ์ การเงินควบคุมได้ดี”
   - เขียนสรุปแบบกระชับ แต่สามารถเปลี่ยนคำ เปลี่ยนรูปประโยคได้ ไม่ต้องเหมือนตัวอย่างเป๊ะ
   - ใช้คำเชื่อมประโยคมาด้วยเพื่อให้อ่านแล้วไหลลื่นมีลูกเล่นไม่ควรบอกข้อมูลล้วน

2) "middle_panel" = สรุปภาพรวมระดับความแข็งแรงทางการเงินของเดือนนั้น
   - ใช้ช่วงคะแนน:
     0–39 = วิกฤต
     40–59 = ต้องระวัง
     60–79 = ดี
     80–100 = ยอดเยี่ยม
   - ให้บอกสถานะตามช่วงคะแนน + เหตุผลสั้น ๆ จากตัวเลข เช่น สัดส่วนการออม หนี้ต่ำ หรือใช้จ่ายเกิน
   - ตัวอย่างโทน:
     "การเงินคุณอยู่ในระดับดีแล้วนะ ใช้จ่ายในสัดส่วนที่สมดุล มีเงินออมและหนี้ต่ำ แสดงว่าควบคุมได้ดีเลย"

3) "right_panel" = คำแนะนำที่ทำได้จริง 1–2 ข้อ
   - ถ้ามีจุดที่เกินเกณฑ์ ให้แนะนำสิ่งที่ควรเริ่มปรับก่อน เช่น ลดค่าเช่า หรือลดรายจ่ายฟุ่มเฟือย
   - ถ้าภาพรวมการเงินดีมาก ให้เน้นชมและชวนให้รักษาพฤติกรรมเดิม เช่น
     "ลองรักษานิสัยการออมและการใช้จ่ายแบบนี้ต่อไป จะช่วยให้ฐานะการเงินมั่นคงขึ้นเรื่อย ๆ"
   - ตัวอย่างสไตล์:
     "ลองพิจารณาหาทางลดค่าเช่าหรือเปลี่ยนที่อยู่อาศัยให้เหมาะสมกว่านี้ก่อน แล้วนำเงินส่วนนี้ไปออมหรือใช้จ่ายอย่างอื่นได้เลย"

ข้อจำกัดสำคัญ:
- ต้องใช้ภาษาไทยทั้งหมด ห้ามมีคำอังกฤษ
- ใช้แต่ตัวเลขจำนวนเต็ม ถ้าเป็นทศนิยมให้ปัดแล้วเขียนเป็นจำนวนเต็ม
- เขียนสั้น กระชับ ไม่เกิน 2 บรรทัดต่อหนึ่ง panel
- โทนเสียงเป็นกันเอง เหมือนพี่ที่มาช่วยจัดการเงินให้แบบใจดี:
  - ไม่ดุ ไม่ใช้คำประชด หรือคำแรงเกินไป เช่น "แย่มาก", "พัง", "เลวร้าย", "ต้องปรับปรุงทันที"
  - ถ้าสถานการณ์ไม่ดี ให้เตือนแบบอ่อนโยน เช่น "ยังต้องระวัง", "ถ้าเริ่มค่อย ๆ ปรับจะดีขึ้น"
  - ถ้ามีจุดที่ผู้ใช้ทำได้ดี ให้ชมเล็กน้อยเพื่อเพิ่มกำลังใจ
- ห้ามทำนายเรื่องไลฟ์สไตล์หรือชีวิตส่วนตัวเกินกว่าตัวเลขที่ได้รับ
- ห้ามมีการใช้ภาษาอังกฤษ
- ให้สลับรูปแบบประโยคบ้าง เพื่อไม่ให้ข้อความซ้ำกันทุกครั้ง แต่ต้องคงความหมายเดิมและไม่พูดยาวเกินไป
- ต้องตอบกลับเป็น JSON object เท่านั้น มี key "left_panel", "middle_panel", "right_panel" เท่านั้น
"""

# ------------------------------------
# 2) USER PROMPT TEMPLATE
# ------------------------------------
USER_PROMPT_TEMPLATE = """
สรุปสถานะการเงินของผู้ใช้จากข้อมูลด้านล่างนี้ และแบ่งออกเป็น 3 ส่วนตามรูปแบบ dashboard:

ข้อมูลเดือนนี้:
- คะแนนสุขภาพการเงิน: {health_score}
- สัดส่วนค่าใช้จ่ายจำเป็น: {actual_needs_pct}% (เกณฑ์ 50%)
- สัดส่วนค่าใช้จ่ายไม่จำเป็น: {actual_wants_pct}% (เกณฑ์ 30%)
- สัดส่วนเงินออม: {actual_savings_pct}% (เกณฑ์ 20%)
- ภาระหนี้: {dsr_pct}% — สถานะ: {dsr_status}
- Survival Ratio (รายได้ต่อรายจ่าย): {survival_ratio}
- ค่าใช้จ่ายจำเป็นเกินกรอบประมาณ: {needs_surplus_amount} บาท
- ค่าใช้จ่ายไม่จำเป็นเกินกรอบประมาณ: {wants_surplus_amount} บาท
- หมวดที่ใช้เยอะที่สุด: {culprit_item} — {culprit_amount} บาท

โปรดสรุปเป็นข้อความสั้น ๆ แยกเป็น 3 ส่วน ได้แก่ left_panel, middle_panel, right_panel ตามรูปแบบ Dashboard
"""

# ------------------------------------
# 3) ฟังก์ชันเรียก Typhoon
# ------------------------------------
def call_typhoon(user_prompt: str) -> dict:
    """
    รับ user_prompt (ที่ format แล้ว) -> ส่งไปถาม Typhoon -> คืน dict ที่มี
    left_panel, middle_panel, right_panel
    """
    response = client.chat.completions.create(
        model="typhoon-v2.5-30b-a3b-instruct",
        messages=[
            {"role": "system", "content": SYSTEM_PROMPT},
            {"role": "user", "content": user_prompt},
        ],
        temperature=0.7,
        max_tokens=2048,
        top_p=0.9,
        # ถ้า lib เวอร์ชันนี้ไม่รองรับ repetition_penalty ก็ไม่ต้องใส่
        # repetition_penalty=1.1,
    )

    content = response.choices[0].message.content

    # แปลงจาก JSON string -> dict
    try:
        data = json.loads(content)
    except json.JSONDecodeError:
        data = {"error": "LLM did not return valid JSON", "raw": content}

    return data


# ------------------------------------
# 4) เทสไฟล์นี้เดี่ยว ๆ (ไม่บังคับ)
# ------------------------------------
if __name__ == "__main__":
    dummy_result = {
        "health_score": 36,
        "actual_needs_pct": 103,
        "actual_wants_pct": 20,
        "actual_savings_pct": -23,
        "dsr_pct": 15,
        "dsr_status": "Excellent",
        "survival_ratio": 0.82,
        "needs_surplus_amount": 10500,
        "wants_surplus_amount": 0,
        "culprit_item": "housing",
        "culprit_amount": 7000,
    }

    prompt = USER_PROMPT_TEMPLATE.format(**dummy_result)
    out = call_typhoon(prompt)
    print(out)